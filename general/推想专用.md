# 发图到服务器
storescu -aet TX_RETRY   -aec TXPACS +sd +r -d 目标机器ip 11111 本地的dicom路径
上传失败的话，可尝试加上（-xs -xt -xv）
storescu -aet TX_RETRY -aec TXPACS +sd +r -d -xs 172.16.1.6 11111 ./tmp/
***

# md5
解压tar包，终端输入：find ./ -type f -print0 | xargs -0 md5sum

# 配置环境(需切换到root用户：sudo su)
[项目地址](https://code.infervision.com/starship/starship_universal_dev_env)


# starship的使用
1. 激活虚拟环境：source /home/tx-deepocean/torchenv/bin/activate

2. 输入： starship new

3. 用户名：zdongdong

4. 登录：[https://code.infervision.com/profile/personal_access_tokens](https://code.infervision.com/profile/personal_access_tokens)

输入任意Name，Scopes三个打钩，然后create

![[Pasted image 20220929171808.png]]

复制token

![[Pasted image 20220929171911.png]]

5. 输入对应的template，如以下是三选一

![[Pasted image 20220929171959.png]]

6.只需写一下第二个project_name，其他回车

![](file:////tmp/wps-zdongdong/ksohtml/wpsWAOlXN.jpg) 

6. 不出意外，模型下载完成

![[Pasted image 20220929172049.png]]


***
# fancy_viewer

![](file:////tmp/wps-zdongdong/ksohtml/wpsMMQTkO.jpg) 

1. 解压

2. 进入路径，打开yml文件，修改目录：

![](file:////tmp/wps-zdongdong/ksohtml/wpsEbmSpP.jpg) 

3. 在解压缩路径中，终端打开： docker-compose up

4. 浏览器：  本地IP：8080
***

# heart-engine 环境问题
![](file:////tmp/wps-zdongdong/ksohtml/wpsZmmWmQ.jpg)

export LD_LIBRARY_PATH=/home/tx-deepocean/venv/lib


![[Pasted image 20220720102725.png]]
2. sudo apt-get update &&sudo  apt-get install -y --no-install-recommends  libglvnd0 libgl1 libglx0 libegl1 libgles2 libsm6 libxrender1 libopengl0

# engine打tag
1. 在分支上首先确认格式化的问题：pre-commit run -a
2. 若出现以下问题，说明存在格式问题，但是会自动修复

![[Pasted image 20220711163043.png]]

3. 再次执行：pre-commit run -a 会出现全部通过，说明修复完成
![[Pasted image 20220711163232.png]]

4. 这时git status ，会发现有文件修改，然后git add 和push到当前分支

5. 修改 pyproject.toml和cu113_env/pyproject.toml的tag号，然后add & push
![[Pasted image 20220711173433.png]]

6.git tag <tag号> & git push origin <tag号>，查看CI结果是否通过
![[Pasted image 20220711173553.png]]

# service打tag
1. git clone ssh://git@code.infervision.com:2022/algorithm/bw/service/heart-cta-service.git
2. git checkout update-ct-heart（切换到对应分支）
3. git fetch -f origin
4. git rebase origin/update-ct-heart
5. 修改pyproject.toml中的tag号
![[Pasted image 20220718112722.png]]
6. poetry update -vvv（或者：poetry update heart-engine -vvv）
7. git status
![[Pasted image 20220718143007.png]]
8. git add poetry.lock
9. git add pyproject.toml
10. git commit -m " "
11. git push update-ct-heart
12. git tag 16.3.0-a0-m@16.2.0
13. git push origin 16.3.0-a0-m@16.2.0
14. 查看CI中的第二步，复制出来image名称用于填写封装需求
![[Pasted image 20220718150051.png]]
![[Pasted image 20220718150032.png]]
15. 打开 [https://test.k8s.infervision.com/#/models](https://test.k8s.infervision.com/#/models)，按照要求上传tar包
![[Pasted image 20220718150257.png]]
16. 在 [https://code.infervision.com/algorithm/bw/service/heart-cta-service/pipelines](https://code.infervision.com/algorithm/bw/service/heart-cta-service/pipelines) 这里点击test
![[Pasted image 20220718150315.png]]


# gdcm解压缩的问题
在dicom主目录终端输入：find -type f |xargs -n1 -I {} gdcmconv -w {} {}


# engine 打tag
submodule有更新时，并到dev之前要执行
![[Pasted image 20221102161909.png]]
并到dev之前要执行 poetry version prerelease


# matrix封装
1、下载并安装slicer  https://wiki.infervision.com/download/attachments/465896569/Slicer-4.13.0-2021-11-03-linux-amd64.tar.gz?version=1&modificationDate=1658478566652&api=v2

2、下载插件module, https://wiki.infervision.com/download/attachments/464589851/module-matrix.zip?version=3&modificationDate=1658374811989&api=v2

3、配置插件，修改文件名Matrix/MatrixLib/config.ini.example为Matrix/MatrixLib/config.ini对其进行配置，base_path 本地存储路径，将来要保存一些预测结果与其它。修改服务器地址为将要部署的服务器地址

4、slicer加载插件module，详见3Dslicer安装matrix插件步骤

5、部署matrix服务端，需要硬件ubk,将服务器机器编码和IP发给陈锡申请

6、cd到服务器infervision/doge下，sudo bash install.sh启动od部署服务

7、访问od的9000端口（服务器ip：9000），用户名tx-deepocean,密码：tuixiang2017, 选择matrix,更新，直接确认至下一步即可，可参考冠脉部署流程 https://wiki.infervision.com/pages/viewpage.action?pageId=316599301

8、通过 http://127.0.0.1:9005/docs 配置服务端，让他知道你的模型，选择put, try it out，name: matrix

9、在engine中docker-compose build 构建镜像，docker push hub.infervision.com/algo/matrix:Aortic上传刚刚构建的镜像，镜像应该统一格式为hub.infervision.com/algo/matrix:XXX，你的tar包应为XXX.tar，XXX处需完全一致，也即你在服务端9005端口配置中的“name”字段

10、将tar包放在Infervision/doge/model下，注意命名

11、进入matrix中，账号txdoctor1,密码tuixiang2020,将原始的dcm压缩为zip格式文件，即可发图预测


# matrix打docker
1. 新建matrix_main.py
2. 新建docker文件夹，放入matrixDockerfile文件
![[Pasted image 20221222194124.png]]
3. 主目录新建pyproject.toml和poetry.lock(注意lock文件中的memory_profiler)，修改toml文件的这一部分
![[Pasted image 20221222193715.png]]
4. 主目录新建docker-compose.matrix.yml, 修改第5行后面的名字
![[Pasted image 20221222193324.png]]
 5. makefile依次执行这三条指令
 6. ![[Pasted image 20221222193907.png]]
# matrix docker打好之后,修改各种文件
1. 9000端口部署服务（系统更新->···->更改产品方案->（通用方案）部署matrix-dev + UNI-matrix_dev）
![[Pasted image 20221223094941.png]]

2. https://wiki.infervision.com/pages/viewpage.action?pageId=478098290
示例：
（检查dlserver/consul.yml文件对matrix有没有分配显卡）
![[Pasted image 20221223151547.png]]
a) ~/Infervision/doge/configs/Matrix/default.yml
![[Pasted image 20221222195211.png]]
b) ~/Infervision/doge/configs/config-products/default.yml
![[Pasted image 20221222195529.png]]
c) ~/Infervision/doge/dlserver/matrix.yaml
![[Pasted image 20221222195911.png]]
d)~/Infervision/doge/docker-compose.matrix-dev.yml
![[Pasted image 20221222200223.png]]
e) 修改ds过滤规则
![[Pasted image 20221222201148.png]]
3. tar包放在Infervision/doge/mode目录下
4. 


